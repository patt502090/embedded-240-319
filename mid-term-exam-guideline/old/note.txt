ด้านล่างนี้คือโค้ดตัวอย่างสไตล์อาจารย์ (ภาษา C ใช้รีจิสเตอร์ AVR) แบ่งเป็น 3 บอร์ด ตามข้อสอบโรงงานยา 6 บล็อก แต่ละบอร์ดมีคอมเมนต์ภาษาไทยอธิบายการทำงานในระดับละเอียด และรองรับข้อกำหนด (9600 bps 8E1, กรองข้อมูล 3 ครั้ง, debounce 50 ms, timeout 30 s ฯลฯ)

บอร์ด 1 – Sensor & Display

Block 1: Pill Counter & Production Display

ใช้ HC‑SR04 วัดระยะ 3 ครั้งติดกัน ถ้าทั้ง 3 ค่า < 10 cm และไม่อยู่ในช่วง lockout 150 ms จะเพิ่มตัวนับเม็ดยา 0–999.

แสดงผลบน LCD 16×2: บรรทัดที่ 1 แสดง “Pills: xxx Target: yyy”; บรรทัดที่ 2 แสดง “Progress: zzz%”.

Block 2: Communication Hub

ใช้ USART0 ที่ 9600 bps 8E1 สื่อสารระหว่างบอร์ด: รับข้อความ TARGET:xxx\n จากบอร์ด 2 เพื่อตั้งเป้าหมาย, ส่ง PILLS:xxx\n และ PROGRESS:yyy\n ไปบอร์ด 3 ทุก 200 ms, และรับ RESET\n จากบอร์ด 3 เพื่อรีเซ็ตการนับ.

มี timeout 30 s ถ้าไม่ได้รับข้อมูลใด ๆ จะแสดงข้อความ “Timeout!” และกระพริบ LED13.

ดูโค้ดได้ที่ไฟล์ board1_sensor.c: board1_sensor.c

บอร์ด 2 – Input Control

Block 3: Quality Control Input

ใช้ keypad แบบ ADC 4×4 บนช่อง A5: อ่านค่าด้วย ADC และแม็พเป็นปุ่มตามช่วงแรงดันในโจทย์ (0–9, *, #).

มีการ debounce 50 ms และ timeout 30 s หากไม่มีการกดจะกลับสู่สถานะพร้อม.

กดตัวเลขสะสมค่าเป้าหมาย 0–999, กด * ล้างค่า, กด # เพื่อส่ง TARGET:xxx\n ไปบอร์ด 1.

Block 4: User Interface Display

ใช้ LCD 16×2 แสดง Set Target: xxx และ Press # to confirm.

ใช้ LED สามสี (เขียว, เหลือง, แดง) บนพอร์ต D เพื่อบอกสถานะ: เขียว = พร้อม, เหลือง = กำลังตั้งค่า, แดง = ข้อผิดพลาด (เช่นค่าเกิน 999).

ดูโค้ดได้ที่ไฟล์ board2_input.c: board2_input.c

บอร์ด 3 – Monitor & Control

Block 5: Production Monitor

รับ PILLS:xxx\n และ PROGRESS:yyy\n จากบอร์ด 1 ผ่าน USART0 (9600 bps 8E1) และปรับเวลาล่าสุด.

แสดงผลบน 7‑segment 4 หลัก: สองหลักซ้ายเป็นจำนวนเม็ด (mod 100) สองหลักขวาเป็นเปอร์เซ็นต์ (mod 100).

ใช้ Timer2 interrupt มัลติเพล็กซ์ 7‑segment ที่ 1 kHz และกระพริบ LED น้ำเงินที่ 4 Hz เมื่อเปอร์เซ็นต์ถึง 100%.

LED สถานะ (เขียว, เหลือง, แดง, น้ำเงิน) ถูกควบคุมตามเปอร์เซ็นต์: เขียว <50%, เหลือง 50–89%, แดง 90–99%, น้ำเงินกระพริบเมื่อ 100%.

Block 6: Cleaning & Batch Control

เมื่อ progress ≥ 100% → เข้าสู่โหมดล้าง: เปิด LED Packaging ที่ PD2 5 วินาที, เปิดวาล์ว Solenoid ที่ PD3 3 วินาที, แสดง “CLEn” บน 7‑segment, ส่งคำสั่ง RESET\n ไปบอร์ด 1 และนับรอบการผลิต.

หลังล้างเสร็จจะกลับสู่โหมด Run และเพิ่มตัวนับ batch.

มีโหมด Timeout: ถ้าไม่ได้รับข้อมูลจากบอร์ด 1 เกิน 30 s จะขึ้น ---- และไฟแดงค้างจนกว่าจะมีข้อมูลใหม่.

ดูโค้ดได้ที่ไฟล์ board3_monitor.c: board3_monitor.c
ทำอะไรกับ "ค่าน้ำ" ในระบบนี้ (สรุปให้ชัด)
• บอร์ด 1 อ่านน้ำจาก A1 → คิดเป็นเปอร์เซ็นต์
• เมื่อ = 80% ต่อเนื่องเล็กน้อย (กันเด้ง):
    1. หยุดนับเม็ดยาชั่วคราว ( water_lock=true ) เพื่อกันล้น/หก
    2. ส่งสัญญาณไปบอร์ด 3: "WATER:HIn" (ครั้งเดียวต่อเหตุการณ์)
• บอร์ด 3 พอรับ "WATER:HI" → เปิดโซลินอยด์ 3 วินาที เพื่อช่วยระบายน้ำทันที
• เมื่อน้ำลดต่ำกว่า 75% (hysteresis): กลับมานับเม็ดยาได้ตามปกติ


ภาพรวมระบบ (สามบอร์ดสื่อสารผ่าน UART 9600 bps 8E1)

Board 2 (Input – Keypad ADC + LCD)

รับค่าจาก Keypad แบบตัวต้านทาน R‑ladder ผ่านช่อง A5 ของ ADC เพื่อตีความเป็นปุ่ม 0–9, *, #

เก็บค่าสะสมเป็นเป้าหมาย (0 – 999 เม็ด), เมื่อกด # จะส่งข้อความ TARGET:xxx\n ไปยัง Board 1

ใช้ LCD 16×2 แสดงข้อความ “Set Target: xxx” และแสดงคำแนะนำการกดปุ่ม

มี LEDs สามสี: เขียว = พร้อมใช้งาน, เหลือง = กำลังตั้งค่า, แดง = เกิดข้อผิดพลาด (เช่น ค่ามากกว่า 999)

เปิดใช้งาน Watchdog Timer ประมาณ 2 วินาที พร้อมฟังก์ชัน timeout 30 วินาทีหากไม่มีการกดปุ่ม

Board 1 (Sensor & Display – HC‑SR04 + Water A1 + LCD)

ใช้ HC‑SR04 ตรวจจับการผ่านของเม็ดยา: ส่งพัลส์ 10 µs จากขา TRIG (D2) แล้ววัดเวลาสะท้อนกลับที่ขา ECHO (D3) ผ่านฟังก์ชัน pulseIn; หากระยะที่วัดได้ น้อยกว่า 10 เซนติเมตร ติดต่อกัน 3 ครั้ง (พร้อมช่วง lockout 150 ms) จะนับเป็นเม็ดยา 1 เม็ด

อ่านค่าระดับน้ำจากเซนเซอร์แอนาล็อกที่ขา A1 (PC1) แปลงเป็นเปอร์เซ็นต์น้ำ (0–100 %)

แสดงผลบน LCD 16×2: บรรทัดแรกแสดงจำนวน Pills และ Target; บรรทัดที่ 2 แสดง Progress (%) และ Water (%)

หากระดับน้ำ ≥ 80 % ต่อเนื่อง (และยังไม่เคยแจ้ง) จะส่งข้อความ WATER:HI\n ไปยัง Board 3 พร้อม หยุดการนับเม็ดยาชั่วคราว เพื่อความปลอดภัย; เมื่อระดับน้ำลดลงต่ำกว่า 75 % จะกลับมานับต่อ

คำนวณเปอร์เซ็นต์ความคืบหน้าด้วยสูตร (pill_count * 100) / target_count (จำกัดสูงสุด 100 %)

ส่งข้อความสถานะไปยัง Board 3 เป็นประจำทุก ~200 มิลลิวินาที (เมื่อมีเป้าหมาย):

PILLS:nnn\n – จำนวนเม็ดยาที่นับได้

PROGRESS:yyy\n – เปอร์เซ็นต์ความคืบหน้า

รับข้อความ TARGET:xxx\n จาก Board 2 เพื่อตั้งเป้าหมายใหม่ และข้อความ RESET\n จาก Board 3 เมื่อจบรอบ เพื่อรีเซ็ตตัวนับ

มี Watchdog Timer ~2 วินาที; หากไม่ได้รับ/ส่งสัญญาณนานเกิน 30 วินาที จะขึ้นข้อความ “Timeout!” บน LCD, กระพริบ LED13 และหยุดป้อน WDT จน MCU รีบูต

Board 3 (Monitor & Control – 7‑segment + LEDs + Solenoid + Packaging)

ใช้ 7‑segment 4 หลักแบบมัลติเพล็กซ์: สองหลักซ้ายแสดง pills % 100, สองหลักขวาแสดง progress % 100

มี LEDs สี่สี: เขียว (<50 %), เหลือง (50–89 %), แดง (90–99 %), และน้ำเงินกระพริบเมื่อ progress ≥ 100 %

ใช้ขา PD2 ควบคุม Packaging LED/Relay และ PD3 ควบคุมโซลินอยด์ (Solenoid)

รับข้อความ PILLS:xxx\n และ PROGRESS:yyy\n จาก Board 1 ผ่าน UART 9600 8E1 และอัปเดตแสดงผลบน 7‑seg/LEDs

เมื่อได้รับ WATER:HI\n จะเปิดโซลินอยด์ 3 วินาที เพื่อระบายน้ำ

เมื่อ progress ≥ 100 % จะเข้าสู่โหมด CLEAN:

เปิด Packaging (PD2) 5 วินาที

เปิด Solenoid (PD3) 3 วินาที

แสดงคำว่า “CLEn” บน 7‑seg

ส่งข้อความ RESET\n กลับไป Board 1 แล้วรีเซ็ตตัวนับ

หากไม่รับข้อมูลจาก Board 1 เกิน 30 วินาที จะเข้าสู่โหมด Timeout: แสดง “----” และเปิดไฟแดงค้างจนกว่าจะมีข้อมูลอีกครั้ง




